<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¨å¹³å°è¯¾å ‚ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary-color: #FF69B4; 
            --danger-color: #FF4500; 
            --success-color: #32CD32; 
            --module-bg: rgba(255, 255, 255, 0.95); 
        } 
        body { 
            font-family: 'Comic Sans MS', cursive; 
            background: linear-gradient(135deg, #FFB6C1 0%, #87CEEB 100%); 
            padding: 20px; 
            min-height: 100vh; 
            margin: 0;
        } 
        .class-manager { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: var(--module-bg); 
            padding: 15px; 
            border-radius: 15px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            border: 2px solid var(--primary-color); 
            z-index: 100; 
        } 
        .class-controls { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px; 
        } 
        .class-selector { 
            flex-grow: 1; 
            padding: 8px; 
            border-radius: 20px; 
            border: 2px solid var(--primary-color); 
        } 
        .container { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            max-width: 1200px; 
            margin: 80px auto 20px; 
        } 
        .module { 
            background: var(--module-bg); 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
            border: 3px solid var(--primary-color); 
            min-height: 300px; 
            display: flex; 
            flex-direction: column; 
        } 
        #nameDisplay { 
            font-size: 24px; 
            text-align: center; 
            padding: 20px; 
            background: #FFFACD; 
            border-radius: 15px; 
            margin: 10px 0; 
            animation: pulse 1s infinite; 
            flex-grow: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        } 
        .score-list { 
            overflow-y: auto; 
            flex-grow: 1; 
            padding: 10px 0; 
        } 
        .score-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px; 
            margin: 5px 0; 
            background: #F0FFF0; 
            border-radius: 10px; 
        } 
        .negative-score { 
            color: var(--danger-color); 
            font-weight: bold; 
        } 
        .group-section { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
            overflow-y: auto; 
            padding: 10px 0; 
        } 
        .group-item { 
            background: #E6E6FA; 
            padding: 15px; 
            border-radius: 10px; 
            text-align: center; 
            position: relative; 
        } 
        @keyframes pulse { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.05); } 
            100% { transform: scale(1); } 
        } 
        button { 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 25px; 
            cursor: pointer; 
            transition: all 0.3s; 
        } 
        .danger-btn { 
            background: var(--danger-color) !important; 
        } 
        .success-btn { 
            background: var(--success-color) !important; 
        } 
        .emoji-badge { 
            position: absolute; 
            right: -10px; 
            top: -10px; 
            background: white; 
            padding: 5px 10px; 
            border-radius: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        } 
        .control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .file-input {
            display: none;
        }
        .import-btn {
            display: inline-block;
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .class-manager {
                position: static;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="class-manager">
        <div class="class-controls">
            <button onclick="createNewClass()">â• æ–°å»º</button>
            <button class="danger-btn" onclick="deleteCurrentClass()">ğŸ—‘ï¸ åˆ é™¤</button>
            <select id="classSelector" class="class-selector" onchange="changeClass()"></select>
        </div>
        <div>å½“å‰ç­çº§ï¼š<span id="currentClass">æ— ç­çº§æ•°æ®</span></div>
        <div class="control-panel">
            <label class="import-btn">
                ğŸˆ æ•°æ®å¯¼å…¥
                <input type="file" id="excelFile" class="file-input" accept=".xlsx,.csv" onchange="importData()">
            </label>
            <button onclick="startRoll()">ğŸ² å¼€å§‹</button>
            <button id="addScoreBtn" onclick="addScoreToSelected()">âœ¨ +1åˆ†</button>
            <button id="minusScoreBtn" onclick="minusScoreToSelected()">âš ï¸ -1åˆ†</button>
            <button class="danger-btn" onclick="clearScores()">æ¸…ç©ºç§¯åˆ†</button>
        </div>
    </div>

    <div class="container">
        <div class="module">
            <h2>ğŸ¯ éšæœºç‚¹å</h2>
            <div id="nameDisplay">å‡†å¤‡å°±ç»ª</div>
        </div>

        <div class="module">
            <h2>â­ å°ç»„ç§¯åˆ†</h2>
            <div id="groupList" class="group-section"></div>
        </div>

        <div class="module">
            <h2>ğŸ† ç§¯åˆ†æ¦œ</h2>
            <div id="scoreList" class="score-list"></div>
        </div>
    </div>

    <script>
        let currentClass = null;
        let students = [];
        let rollInterval;
        let lastSelectedIndex = -1;

        // è·¨å¹³å°å­˜å‚¨è§£å†³æ–¹æ¡ˆ - å¢å¼ºç‰ˆ
        const StorageManager = {
            // å°è¯•å¤šç§å­˜å‚¨æ–¹å¼ï¼Œä¼˜å…ˆä½¿ç”¨localStorageï¼Œå¤±è´¥åˆ™é™çº§
            setItem: async function(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.warn("localStorage å¤±è´¥ï¼Œå°è¯•sessionStorage:", e);
                    try {
                        sessionStorage.setItem(key, JSON.stringify(value));
                        return true;
                    } catch (e2) {
                        console.warn("sessionStorage å¤±è´¥ï¼Œå°è¯•IndexedDB:", e2);
                        try {
                            await this.setItemIndexedDB(key, value);
                            return true;
                        } catch (e3) {
                            console.error("æ‰€æœ‰å­˜å‚¨æ–¹å¼å‡å¤±è´¥:", e3);
                            return false;
                        }
                    }
                }
            },

            getItem: async function(key) {
                try {
                    const item = localStorage.getItem(key);
                    if (item) return JSON.parse(item);
                } catch (e) {
                    console.warn("ä»localStorageè·å–å¤±è´¥:", e);
                }

                try {
                    const item = sessionStorage.getItem(key);
                    if (item) return JSON.parse(item);
                } catch (e) {
                    console.warn("ä»sessionStorageè·å–å¤±è´¥:", e);
                }

                try {
                    return await this.getItemIndexedDB(key);
                } catch (e) {
                    console.error("ä»IndexedDBè·å–å¤±è´¥:", e);
                    return null;
                }
            },

            // IndexedDBå®ç°
            initDB: function() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('ClassScoreDB', 1);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('storage')) {
                            db.createObjectStore('storage', { keyPath: 'id' });
                        }
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };

                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            },

            setItemIndexedDB: async function(key, value) {
                if (!this.db) await this.initDB();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['storage'], 'readwrite');
                    const store = transaction.objectStore('storage');
                    
                    const request = store.put({ id: key, data: value });
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            },

            getItemIndexedDB: async function(key) {
                if (!this.db) await this.initDB();
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['storage'], 'readonly');
                    const store = transaction.objectStore('storage');
                    
                    const request = store.get(key);
                    
                    request.onsuccess = () => {
                        resolve(request.result ? request.result.data : null);
                    };
                    request.onerror = () => reject(request.error);
                });
            }
        };

        // ç­çº§ç®¡ç†
        async function initClassManager() {
            try {
                const classes = await StorageManager.getItem('classList') || [];
                const selector = document.getElementById('classSelector');
                selector.innerHTML = classes.map(c => `<option value="${c}">${c}</option>`);
                
                if (classes.length > 0) {
                    currentClass = classes[0];
                    document.getElementById('currentClass').textContent = currentClass;
                    await loadData();
                } else {
                    document.getElementById('currentClass').textContent = "æ— ç­çº§æ•°æ®";
                    students = [];
                    updateAll();
                }
            } catch (error) {
                console.error("åˆå§‹åŒ–ç­çº§ç®¡ç†å¤±è´¥:", error);
                alert("æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
            }
        }

        async function createNewClass() {
            const className = prompt("è¯·è¾“å…¥æ–°ç­çº§åç§°ï¼š");
            if (!className) return;

            try {
                const classes = await StorageManager.getItem('classList') || [];
                if (!classes.includes(className)) {
                    classes.push(className);
                    await StorageManager.setItem('classList', classes);
                    await StorageManager.setItem(`studentData_${className}`, []);
                    currentClass = className;
                    initClassManager();
                } else {
                    alert("ç­çº§å·²å­˜åœ¨ï¼");
                }
            } catch (error) {
                console.error("åˆ›å»ºç­çº§å¤±è´¥:", error);
                alert("åˆ›å»ºç­çº§å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }

        async function deleteCurrentClass() {
            if (!currentClass || !confirm(`ç¡®å®šè¦åˆ é™¤ã€${currentClass}ã€‘å—ï¼Ÿ`)) return;

            try {
                const classes = await StorageManager.getItem('classList') || [];
                const newClasses = classes.filter(c => c !== currentClass);
                
                await StorageManager.setItem('classList', newClasses);
                await StorageManager.setItem(`studentData_${currentClass}`, null);
                
                currentClass = newClasses.length > 0 ? newClasses[0] : null;
                initClassManager();
            } catch (error) {
                console.error("åˆ é™¤ç­çº§å¤±è´¥:", error);
                alert("åˆ é™¤ç­çº§å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }

        async function changeClass() {
            currentClass = document.getElementById('classSelector').value;
            document.getElementById('currentClass').textContent = currentClass;
            await loadData();
        }

        // æ•°æ®ç®¡ç†
        async function loadData() {
            try {
                const saved = await StorageManager.getItem(`studentData_${currentClass}`);
                students = saved || [];
                updateAll();
            } catch (error) {
                console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
                alert("åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }

        async function saveData() {
            try {
                await StorageManager.setItem(`studentData_${currentClass}`, students);
            } catch (error) {
                console.error("ä¿å­˜æ•°æ®å¤±è´¥:", error);
                alert("æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }

        // Excelå¯¼å…¥ - ç§»é™¤å¤–éƒ¨ä¾èµ–
        async function importData() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) return;

            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰XLSXåº“
                if (typeof XLSX === 'undefined') {
                    alert("å¯¼å…¥åŠŸèƒ½éœ€è¦é¢å¤–åº“æ”¯æŒï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨é‡è¯•");
                    return;
                }

                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        if (!jsonData.length) {
                            alert("æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼");
                            return;
                        }

                        // æå–ç­çº§åç§°
                        let className = jsonData[0]?.ç­çº§ || '';
                        if (!className) {
                            className = prompt("è¯·è¾“å…¥ç­çº§åç§°ï¼š");
                            if (!className) return;
                        }

                        // æ›´æ–°ç­çº§åˆ—è¡¨
                        const classes = await StorageManager.getItem('classList') || [];
                        if (!classes.includes(className)) {
                            classes.push(className);
                            await StorageManager.setItem('classList', classes);
                        }

                        // å¤„ç†å­¦ç”Ÿæ•°æ®
                        const studentsData = jsonData.map(item => ({
                            id: (item.å­¦å· || item.ID || Date.now()).toString(),
                            name: item.å§“å || item.Name || 'æœªçŸ¥å§“å',
                            group: item.å°ç»„ || item.Group || 'æœªåˆ†ç»„',
                            score: 0
                        }));

                        // ä¿å­˜æ•°æ®
                        currentClass = className;
                        students = studentsData;
                        await saveData();
                        initClassManager();
                        alert(`æˆåŠŸå¯¼å…¥ ${students.length} æ¡å­¦ç”Ÿæ•°æ®ï¼`);
                    } catch (error) {
                        console.error("è§£ææ–‡ä»¶å¤±è´¥:", error);
                        alert("æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼");
                    }
                };
                reader.onerror = function() {
                    alert("æ–‡ä»¶è¯»å–å¤±è´¥ï¼");
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error("å¯¼å…¥æ•°æ®å¤±è´¥:", error);
                alert("å¯¼å…¥æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
        }

        // éšæœºç‚¹å
        function startRoll() {
            if (students.length === 0) {
                alert("è¯·å…ˆå¯¼å…¥æ•°æ®ï¼");
                return;
            }

            let count = 0;
            lastSelectedIndex = -1;
            document.getElementById('addScoreBtn').disabled = true;
            document.getElementById('minusScoreBtn').disabled = true;
            clearInterval(rollInterval);

            rollInterval = setInterval(() => {
                if (count++ > 25) {
                    clearInterval(rollInterval);
                    document.getElementById('addScoreBtn').disabled = false;
                    document.getElementById('minusScoreBtn').disabled = false;
                    return;
                }
                
                // ç¡®ä¿ä¸è¿ç»­é€‰ä¸­åŒä¸€ä¸ªäºº
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * students.length);
                } while (students.length > 1 && newIndex === lastSelectedIndex);
                
                lastSelectedIndex = newIndex;
                document.getElementById('nameDisplay').textContent = students[newIndex].name;
            }, 50);
        }

        // ç§¯åˆ†ç®¡ç† - å…è®¸è´Ÿåˆ†
        function updateScore(studentId, delta) {
            const index = students.findIndex(s => s.id === studentId);
            if (index === -1) return;
            
            // ç§»é™¤åˆ†æ•°ä¸‹é™é™åˆ¶ï¼Œå…è®¸è´Ÿåˆ†
            students[index].score += delta;
            saveData();
            updateAll();
        }

        function addScoreToSelected() {
            if (lastSelectedIndex !== -1 && students.length > 0) {
                updateScore(students[lastSelectedIndex].id, 1);
            }
        }

        function minusScoreToSelected() {
            if (lastSelectedIndex !== -1 && students.length > 0) {
                updateScore(students[lastSelectedIndex].id, -1);
            }
        }

        async function clearScores() {
            if (!confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç§¯åˆ†å—ï¼Ÿ")) return;
            
            students.forEach(s => s.score = 0);
            await saveData();
            updateAll();
        }

        // å°ç»„ç§¯åˆ†ï¼ˆå…è®¸è´Ÿåˆ†ï¼‰
        function updateGroupScore(group, delta) {
            students = students.map(student => {
                if (student.group === group) {
                    return { ...student, score: student.score + delta };
                }
                return student;
            });
            saveData();
            updateAll();
        }

        // ç•Œé¢æ›´æ–°
        function updateAll() {
            // æ›´æ–°ç§¯åˆ†æ¦œ
            const sortedStudents = [...students].sort((a, b) => b.score - a.score);
            const scoreList = document.getElementById('scoreList');
            scoreList.innerHTML = sortedStudents.map(student => `
                <div class="score-item">
                    <span>${student.name} (${student.id})</span>
                    <div class="controls">
                        <span class="${student.score < 0 ? 'negative-score' : ''}">â­ ${student.score}</span>
                        <button onclick="updateScore('${student.id}', 1)">+1</button>
                        <button onclick="updateScore('${student.id}', -1)">-1</button>
                    </div>
                </div>
            `).join('');

            // æ›´æ–°å°ç»„åˆ—è¡¨
            const groups = [...new Set(students.map(s => s.group))];
            const groupList = document.getElementById('groupList');
            groupList.innerHTML = groups.map(group => {
                const members = students.filter(s => s.group === group);
                const total = members.reduce((sum, m) => sum + m.score, 0);
                
                return `
                    <div class="group-item">
                        <div class="emoji-badge ${total < 0 ? 'negative-score' : ''}">ğŸ… ${total}</div>
                        <h3>${group}</h3>
                        ${members.map(m => `<div>${m.name}</div>`).join('')}
                        <div class="btn-group">
                            <button onclick="updateGroupScore('${group.replace(/'/g, "\\'")}', 5)">+5</button>
                            <button onclick="updateGroupScore('${group.replace(/'/g, "\\'")}', -5)">-5</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('load', async () => {
            try {
                await StorageManager.initDB();
                await initClassManager();
            } catch (error) {
                console.error("åº”ç”¨åˆå§‹åŒ–å¤±è´¥:", error);
                alert("ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
            }
        });
    </script>
</body>
</html>